#!/bin/bash

# Define color variables
LIGHT_BLUE='\033[1;34m'
LIGHT_GREEN='\033[1;32m'
LIGHT_RED='\033[1;31m'
NC='\033[0m' # No Color

# Function to check for root user
check_root() {
    if [ "$(id -u)" -ne 0 ]; then
        echo -e "${LIGHT_BLUE}This script requires root privileges!${NC}"
        echo -e "${LIGHT_BLUE}Attempting to switch to root using 'sudo -i'...${NC}"
        exec sudo -i "$0" "$@"
        exit 1
    fi
}

# Function to check if the network is active
check_network() {
    if ! systemctl is-active --quiet network-online.target; then
        echo -e "${LIGHT_BLUE}Network is not active!${NC}"
        exit 1
    fi
}

# Function to partition disk
partition_disk() {
    echo -e "${LIGHT_GREEN}Partitioning $disk${NC}"
    
    if [ "$boot_type" = "UEFI" ]; then
        parted "$disk" -- mklabel gpt
        parted "$disk" -- mkpart primary 512MB -8GB
        parted "$disk" -- mkpart primary linux-swap -8GB 100%
        parted "$disk" -- mkpart ESP fat32 1MB 512MB
    else
        parted "$disk" -- mklabel msdos
        parted "$disk" -- mkpart primary 1MB -8GB
        parted "$disk" -- mkpart primary linux-swap -8GB 100%
    fi
    
    if [ $? -eq 0 ]; then
        echo -e "${LIGHT_GREEN}Partitioning complete.${NC}"
    else
        echo -e "${LIGHT_RED}Partitioning failed! Please check the disk device.${NC}"
        exit 1
    fi
}

# Function to format partitions
format_partitions() {
    echo -e "${LIGHT_GREEN}Formatting partitions${NC}"

    if [ "$boot_type" = "UEFI" ]; then
        mkfs.ext4 "${disk}1"
        mkswap "${disk}2" && swapon "${disk}2"
        mkfs.fat -F 32 "${disk}3"
        mount "${disk}1" /mnt
        mkdir -p /mnt/boot
        mount "${disk}3" /mnt/boot
    else
        mkfs.ext4 "${disk}1"
        mount "${disk}1" /mnt
    fi

    if [ $? -eq 0 ]; then
        echo -e "${LIGHT_GREEN}Partitions formatted and mounted to /mnt${NC}"
    else
        echo -e "${LIGHT_RED}Formatting failed!${NC}"
        exit 1
    fi
}

# Function to clone repository
clone_repository() {
    echo -e "${LIGHT_GREEN}Cloning LingmoNix Starter${NC}"
    
    while true; do
        read -p "Enter region (Global or China): " region </dev/tty
        case $region in
            Global)
                repo_url="https://github.com/LingmoOS-Testing/LingmoNix-Starter.git"
                break
                ;;
            China)
                repo_url="https://gitee.com/arkimium_76/LingmoNix-Starter.git"
                break
                ;;
            *)
                echo "Invalid option, please choose again."
                ;;
        esac
    done

    git clone "$repo_url" /mnt/tmp
    if [ $? -ne 0 ]; then
        echo -e "${LIGHT_BLUE}Failed to clone the repository, please check the network connection!${NC}"
        exit 1
    fi
}

# Function to choose flavor
choose_flavor() {
    while true; do
        echo "Please choose the flavor version to install:"
        echo "1) general"
        echo "2) studio"
        echo "3) neon"
        read -p "Enter flavor (1, 2, or 3): " flavor_choice </dev/tty
        case $flavor_choice in
            1|general)
                flavor="general"
                break
                ;;
            2|studio)
                flavor="studio"
                break
                ;;
            3|neon)
                flavor="neon"
                break
                ;;
            *)
                echo "Invalid option, please enter 1, 2, or 3."
                ;;
        esac
    done
}

# Function to choose language
choose_language() {
    while true; do
        echo "Please choose the language version:"
        echo "1) English"
        echo "2) Chinese"
        read -p "Enter language (1 or 2): " lang_choice </dev/tty
        case $lang_choice in
            1|English)
                flavor_dir="${flavor,,}" # Convert flavor name to lowercase
                break
                ;;
            2|Chinese)
                flavor_dir="${flavor,,}-cn" # Convert flavor name to lowercase and append "-cn"
                break
                ;;
            *)
                echo "Invalid option, please enter 1 or 2."
                ;;
        esac
    done
}

# Function to install NixOS
install_nixos() {
    echo -e "${LIGHT_GREEN}Starting NixOS installation${NC}..."
    if [ "$region" = "China" ]; then
        echo -e "${LIGHT_GREEN}Using Tsinghua mirror for China...${NC}"
        nixos-install -j 8 --cores 1 --option substituters https://mirrors.tuna.tsinghua.edu.cn/nix-channels/store
    else
        nixos-install -j 8 --cores 1
    fi
    if [ $? -eq 0 ]; then
        echo -e "${LIGHT_GREEN}NixOS installation completed${NC}"
    else
        echo -e "${LIGHT_RED}NixOS installation failed!${NC}"
        exit 1
    fi
}

# Main function to run the installation
main() {
    clear
    check_root
    check_network

    echo -e "${LIGHT_GREEN}Welcome to Yaksha!${NC}"
    echo -e "${LIGHT_GREEN}LingmoNix installation script${NC}"
    echo "---------------------------------"

    echo -e "${LIGHT_GREEN}1. Detecting boot method${NC}"
    if [ -f /sys/firmware/efi/fw_platform_size ]; then
        echo -e "${LIGHT_GREEN}UEFI boot mode detected.${NC}"
        boot_type="UEFI"
    else
        echo -e "${LIGHT_GREEN}BIOS boot mode detected.${NC}"
        boot_type="BIOS"
    fi

    # Partition the disk
    echo -e "${LIGHT_BLUE}Please enter the target disk device (e.g., /dev/sda):${NC}"
    lsblk
    while true; do
        read -p "Choose a disk: " disk </dev/tty
        if [ -b "$disk" ]; then
            break
        else
            echo -e "${LIGHT_RED}Invalid device, please provide a valid disk device!${NC}"
        fi
    done

    partition_disk
    format_partitions

    clone_repository
    choose_flavor
    choose_language

    cp -r "/mnt/tmp/${flavor_dir}/configuration.nix" /mnt/etc/nixos/configuration.nix
    if [ $? -eq 0 ]; then
        echo -e "${LIGHT_GREEN}Configuration file copied successfully.${NC}"
    else
        echo -e "${LIGHT_RED}Failed to copy configuration file!${NC}"
        exit 1
    fi

    install_nixos

    echo -e "${LIGHT_GREEN}Post-installation setup complete!${NC}"

    logout
    echo -e "${LIGHT_GREEN}Thank you for using Yaksha!${NC}"
    echo -e "${LIGHT_GREEN}Please reboot and remove your installation medium!${NC}"
}

# Run the main function
main
